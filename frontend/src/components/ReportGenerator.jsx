import { useState } from 'react';
import axios from 'axios';
import { jsPDF } from 'jspdf';
import '../styles/ReportGenerator.css';

export default function ReportGenerator({ 
  result, 
  user, 
  selectedPatient, 
  diagnosticId, 
  signature,
  onReportGenerated 
}) {
  const [generating, setGenerating] = useState(false);
  const [language, setLanguage] = useState('fr');
  const [format, setFormat] = useState('pdf');

  const translations = {
    fr: {
      title: 'RAPPORT D\'ANALYSE PULMONAIRE - IA',
      patient: 'Patient',
      doctor: 'MÃ©decin',
      date: 'Date',
      diagnosis: 'Diagnostic',
      confidence: 'Niveau de confiance',
      probabilities: 'ProbabilitÃ©s dÃ©taillÃ©es',
      cancer: 'Cancer',
      normal: 'Normal',
      riskLevel: 'Niveau de risque',
      description: 'DESCRIPTION CLINIQUE',
      recommendations: 'RECOMMANDATIONS MÃ‰DICALES',
      signature: 'SIGNATURE DU MÃ‰DECIN',
      signedBy: 'SignÃ© par',
      warning: 'AVERTISSEMENT',
      warningText: "Ce rapport est gÃ©nÃ©rÃ© par un systÃ¨me d'intelligence artificielle. Il ne remplace pas l'avis d'un professionnel de santÃ© qualifiÃ©. Toute dÃ©cision mÃ©dicale doit Ãªtre validÃ©e par un mÃ©decin.",
      footer: 'MediCare Diagnostics - SystÃ¨me d\'aide au diagnostic par IA'
    },
    en: {
      title: 'LUNG ANALYSIS REPORT - AI',
      patient: 'Patient',
      doctor: 'Doctor',
      date: 'Date',
      diagnosis: 'Diagnosis',
      confidence: 'Confidence level',
      probabilities: 'Detailed probabilities',
      cancer: 'Cancer',
      normal: 'Normal',
      riskLevel: 'Risk level',
      description: 'CLINICAL DESCRIPTION',
      recommendations: 'MEDICAL RECOMMENDATIONS',
      signature: 'DOCTOR\'S SIGNATURE',
      signedBy: 'Signed by',
      warning: 'WARNING',
      warningText: 'This report is generated by an artificial intelligence system. It does not replace the advice of a qualified healthcare professional. All medical decisions must be validated by a doctor.',
      footer: 'MediCare Diagnostics - AI-assisted diagnostic system'
    },
    ar: {
      title: 'ØªÙ‚Ø±ÙŠØ± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¦Ø© - Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ',
      patient: 'Ø§Ù„Ù…Ø±ÙŠØ¶',
      doctor: 'Ø§Ù„Ø·Ø¨ÙŠØ¨',
      date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
      diagnosis: 'Ø§Ù„ØªØ´Ø®ÙŠØµ',
      confidence: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø«Ù‚Ø©',
      probabilities: 'Ø§Ù„Ø§Ø­ØªÙ…Ø§Ù„Ø§Øª Ø§Ù„ØªÙØµÙŠÙ„ÙŠØ©',
      cancer: 'Ø³Ø±Ø·Ø§Ù†',
      normal: 'Ø·Ø¨ÙŠØ¹ÙŠ',
      riskLevel: 'Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø®Ø·Ø±',
      description: 'Ø§Ù„ÙˆØµÙ Ø§Ù„Ø³Ø±ÙŠØ±ÙŠ',
      recommendations: 'Ø§Ù„ØªÙˆØµÙŠØ§Øª Ø§Ù„Ø·Ø¨ÙŠØ©',
      signature: 'ØªÙˆÙ‚ÙŠØ¹ Ø§Ù„Ø·Ø¨ÙŠØ¨',
      signedBy: 'ÙˆÙ‚Ø¹ Ù…Ù† Ù‚Ø¨Ù„',
      warning: 'ØªØ­Ø°ÙŠØ±',
      warningText: 'Ù‡Ø°Ø§ Ø§Ù„ØªÙ‚Ø±ÙŠØ± ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ù†Ø¸Ø§Ù… Ø°ÙƒØ§Ø¡ Ø§ØµØ·Ù†Ø§Ø¹ÙŠ. Ù„Ø§ ÙŠØ­Ù„ Ù…Ø­Ù„ Ø±Ø£ÙŠ Ø£Ø®ØµØ§Ø¦ÙŠ Ø±Ø¹Ø§ÙŠØ© ØµØ­ÙŠØ© Ù…Ø¤Ù‡Ù„. ÙŠØ¬Ø¨ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ© Ù…Ù† Ù‚Ø¨Ù„ Ø·Ø¨ÙŠØ¨.',
      footer: 'MediCare Diagnostics - Ù†Ø¸Ø§Ù… Ù…Ø³Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ´Ø®ÙŠØµ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ'
    }
  };

  const t = translations[language];

  const getPatientName = () => {
    return user.role === 'medecin' 
      ? `${selectedPatient?.prenom || ''} ${selectedPatient?.nom || ''}`
      : `${user.prenom} ${user.nom}`;
  };

  const getDoctorName = () => {
    return user.role === 'medecin'
      ? `Dr. ${user.prenom} ${user.nom}`
      : (user.medecin_nom || 'MÃ©decin non assignÃ©');
  };

  const generateTXT = () => {
    const patientName = getPatientName();
    const doctorName = getDoctorName();
    const dateStr = new Date().toLocaleString(language === 'ar' ? 'ar-MA' : language === 'en' ? 'en-US' : 'fr-FR');

    const content = `
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         ${t.title}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

${t.patient}: ${patientName}
${t.date}: ${dateStr}
${t.doctor}: ${doctorName}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.diagnosis.toUpperCase()}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${t.diagnosis}: ${result.class}
${t.confidence}: ${result.confidence.toFixed(2)}%
${t.riskLevel}: ${result.risk_level}

${t.probabilities}:
  â€¢ ${t.cancer}: ${(result.probabilities.cancer * 100).toFixed(2)}%
  â€¢ ${t.normal}: ${(result.probabilities.normal * 100).toFixed(2)}%

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.description}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${result.description}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.recommendations}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${result.recommendation}

${signature ? `
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.signature}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.signedBy}: ${doctorName}
${t.date}: ${dateStr}
` : ''}

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${t.warning}
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

${t.warningText}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        ${t.footer}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    `.trim();

    const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = `Rapport_${patientName.replace(/\s/g, '_')}_${Date.now()}.txt`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    if (onReportGenerated) {
      onReportGenerated({ success: true, format: 'txt' });
    }

    alert('âœ… Rapport TXT tÃ©lÃ©chargÃ© avec succÃ¨s !');
  };

  const generatePDF = async () => {
    if (!result) {
      alert('âŒ Aucun rÃ©sultat Ã  exporter');
      return;
    }

    setGenerating(true);

    try {
      const doc = new jsPDF();
      const patientName = getPatientName();
      const doctorName = getDoctorName();
      const dateStr = new Date().toLocaleString(language === 'ar' ? 'ar-MA' : language === 'en' ? 'en-US' : 'fr-FR');

      let yPos = 20;

      // Titre
      doc.setFontSize(18);
      doc.setFont('helvetica', 'bold');
      doc.text(t.title, 105, yPos, { align: 'center' });

      yPos += 15;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');

      // Patient
      doc.setFont('helvetica', 'bold');
      doc.text(`${t.patient}:`, 20, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text(patientName, 60, yPos);

      yPos += 7;
      doc.setFont('helvetica', 'bold');
      doc.text(`${t.doctor}:`, 20, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text(doctorName, 60, yPos);

      yPos += 7;
      doc.setFont('helvetica', 'bold');
      doc.text(`${t.date}:`, 20, yPos);
      doc.setFont('helvetica', 'normal');
      doc.text(dateStr, 60, yPos);

      // Diagnostic
      yPos += 15;
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(14);
      doc.text(t.diagnosis.toUpperCase(), 20, yPos);

      yPos += 10;
      doc.setFontSize(16);
      doc.text(result.class, 20, yPos);

      yPos += 10;
      doc.setFontSize(11);
      doc.setFont('helvetica', 'normal');
      doc.text(`${t.confidence}: ${result.confidence.toFixed(2)}%`, 20, yPos);

      // ProbabilitÃ©s
      yPos += 12;
      doc.setFont('helvetica', 'bold');
      doc.text(`${t.probabilities}:`, 20, yPos);

      yPos += 7;
      doc.setFont('helvetica', 'normal');
      doc.text(`- ${t.cancer}: ${(result.probabilities.cancer * 100).toFixed(2)}%`, 25, yPos);

      yPos += 6;
      doc.text(`- ${t.normal}: ${(result.probabilities.normal * 100).toFixed(2)}%`, 25, yPos);

      yPos += 6;
      doc.text(`- ${t.riskLevel}: ${result.risk_level}`, 25, yPos);

      // Description
      yPos += 12;
      doc.setFont('helvetica', 'bold');
      doc.text(t.description, 20, yPos);

      yPos += 7;
      doc.setFont('helvetica', 'normal');
      const descLines = doc.splitTextToSize(result.description, 170);
      doc.text(descLines, 20, yPos);
      yPos += descLines.length * 6;

      // Recommandations
      yPos += 10;
      doc.setFont('helvetica', 'bold');
      doc.text(t.recommendations, 20, yPos);

      yPos += 7;
      doc.setFont('helvetica', 'normal');
      const recoLines = doc.splitTextToSize(result.recommendation, 170);
      doc.text(recoLines, 20, yPos);
      yPos += recoLines.length * 6;

      // Signature
      if (signature) {
        yPos += 15;
        doc.setFont('helvetica', 'bold');
        doc.text(t.signature, 20, yPos);

        yPos += 5;
        try {
          doc.addImage(signature, 'PNG', 20, yPos, 60, 30);
          yPos += 35;
        } catch (e) {
          console.error('Erreur ajout signature:', e);
          yPos += 10;
        }

        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.text(`${t.signedBy}: ${doctorName}`, 20, yPos);
        yPos += 5;
        doc.text(`${t.date}: ${dateStr}`, 20, yPos);
      }

      // Avertissement
      yPos += 15;
      doc.setFontSize(9);
      doc.setFont('helvetica', 'bold');
      doc.text(t.warning, 20, yPos);

      yPos += 6;
      doc.setFont('helvetica', 'normal');
      const warningLines = doc.splitTextToSize(t.warningText, 170);
      doc.text(warningLines, 20, yPos);

      // Pied de page
      doc.setFontSize(8);
      doc.text(t.footer, 105, 285, { align: 'center' });

      // TÃ©lÃ©charger
      const fileName = `Rapport_${patientName.replace(/\s/g, '_')}_${Date.now()}.pdf`;
      doc.save(fileName);

      if (onReportGenerated) {
        onReportGenerated({ success: true, fileName });
      }

      alert('âœ… Rapport PDF tÃ©lÃ©chargÃ© avec succÃ¨s !');

    } catch (error) {
      console.error('âŒ Erreur gÃ©nÃ©ration PDF:', error);
      alert('âŒ Erreur lors de la gÃ©nÃ©ration du PDF');
    } finally {
      setGenerating(false);
    }
  };

  const handleGenerate = () => {
    setGenerating(true);
    try {
      if (format === 'txt') {
        generateTXT();
      } else {
        generatePDF();
      }
    } finally {
      setGenerating(false);
    }
  };

  return (
    <div className="report-generator">
      <div className="report-header">
        <div className="report-icon">ğŸ“„</div>
        <div className="report-info">
          <h3>Rapport MÃ©dical PersonnalisÃ©</h3>
          <p>Choisissez la langue et le format du rapport</p>
        </div>
      </div>

      <div className="report-options">
        <div className="option-group">
          <label>ğŸŒ Langue</label>
          <select value={language} onChange={(e) => setLanguage(e.target.value)}>
            <option value="fr">ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="en">ğŸ‡¬ğŸ‡§ English</option>
            <option value="ar">ğŸ‡²ğŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
          </select>
        </div>

        <div className="option-group">
          <label>ğŸ“‘ Format</label>
          <select value={format} onChange={(e) => setFormat(e.target.value)}>
            <option value="pdf">ğŸ“• PDF</option>
            <option value="txt">ğŸ“„ TXT</option>
          </select>
        </div>
      </div>

      <div className="report-details">
        <div className="report-detail-item">
          <span className="detail-icon">ğŸ‘¤</span>
          <div>
            <strong>Patient</strong>
            <p>{getPatientName()}</p>
          </div>
        </div>

        <div className="report-detail-item">
          <span className="detail-icon">ğŸ‘¨â€âš•ï¸</span>
          <div>
            <strong>MÃ©decin</strong>
            <p>{getDoctorName()}</p>
          </div>
        </div>

        <div className="report-detail-item">
          <span className="detail-icon">ğŸ“‹</span>
          <div>
            <strong>Diagnostic</strong>
            <p className={`diagnosis-badge ${result?.color}`}>
              {result?.class || 'N/A'}
            </p>
          </div>
        </div>

        {signature && (
          <div className="report-detail-item">
            <span className="detail-icon">âœ…</span>
            <div>
              <strong>Statut</strong>
              <p style={{ color: '#10b981', fontWeight: 600 }}>
                SignÃ© Ã©lectroniquement
              </p>
            </div>
          </div>
        )}
      </div>

      <button
        onClick={handleGenerate}
        disabled={generating || !result}
        className="btn-download-pdf"
      >
        {generating ? (
          <>
            <span className="spinner-small"></span>
            GÃ©nÃ©ration en cours...
          </>
        ) : (
          <>
            ğŸ“¥ TÃ©lÃ©charger le Rapport {format.toUpperCase()}
          </>
        )}
      </button>

      {!signature && user.role === 'medecin' && (
        <p className="report-warning">
          ğŸ’¡ <strong>Astuce :</strong> Ajoutez votre signature Ã©lectronique avant de gÃ©nÃ©rer le rapport final
        </p>
      )}
    </div>
  );
}